MODULE MF
  
  USE COSMO
  USE POWER_SPECTRUM

CONTAINS


  FUNCTION dNdM500c(M500c,REDSHIFT)

    IMPLICIT NONE
    REAL(8) :: dNdM500c, M500c
    REAL(8) :: RSIZE, DSIGMADM, REDSHIFT, nu, nu_f_nu
    REAL(8) :: ACAP_M500c, ASMALL_M500c, PSMALL_M500c   
    REAL(8) :: OMEGAMZ, DELTA_VIR, x

    RSIZE=(R_to_M*M500c)**(1.d0/3.d0)
    DSIGMADM=DSIGMADR_R(RSIZE)*R_to_M/3./(R_to_M*M500c)**(2./3.)
    nu=(DELTAC(OMEGA_M,REDSHIFT)/SIGMA_R(RSIZE)/D_PLUS(REDSHIFT))**2

    OMEGAMZ=OMEGA_M*(1.d0+REDSHIFT)**3*inv_hubblez(REDSHIFT)**2
    DELTA_VIR=18.d0*PI**2+82.d0*(OMEGAMZ-1.d0)-39.d0*(OMEGAMZ-1.d0)**2
    x=log10(500./DELTA_VIR)

    ACAP_M500c=-2.08511667*x**2+2.71726345*x-0.59113241
    ASMALL_M500c=-1.0788725*x**2+3.25302957*x-0.32810261
    PSMALL_M500c=1.04288295*x**2-1.76269479*x+0.06162189

    nu_f_nu=ACAP_M500c*sqrt(ASMALL_M500c*nu/2.d0/PI)* &
         & (1.d0+(1.d0/(nu*ASMALL_M500c))**PSMALL_M500c)* &
         & exp(-ASMALL_M500c*nu/2.d0)

    dNdM500c=2.d0*nu_f_nu*RHO_M/M500c*(-1.d0/SIGMA_R(RSIZE)*DSIGMADM)     

  END FUNCTION dNdM500c

  FUNCTION dNdM1000c(M1000c,REDSHIFT)

    IMPLICIT NONE
    REAL(8) :: dNdM1000c,M1000c
    REAL(8) :: RSIZE, DSIGMADM, REDSHIFT, nu, nu_f_nu
    REAL(8) :: ACAP_M1000c, ASMALL_M1000c, PSMALL_M1000c
    REAL(8) :: OMEGAMZ, DELTA_VIR, x

    RSIZE=(R_to_M*M1000c)**(1.d0/3.d0)
    DSIGMADM=DSIGMADR_R(RSIZE)*R_to_M/3./(R_to_M*M1000c)**(2./3.)
    nu=(DELTAC(OMEGA_M,REDSHIFT)/SIGMA_R(RSIZE)/D_PLUS(REDSHIFT))**2

    OMEGAMZ=OMEGA_M*(1.d0+REDSHIFT)**3*inv_hubblez(REDSHIFT)**2
    DELTA_VIR=18.d0*PI**2+82.d0*(OMEGAMZ-1.d0)-39.d0*(OMEGAMZ-1.d0)**2    
    x=log10(1000/DELTA_VIR)

    ACAP_M1000c=-1.65696205*x**2+3.07836133*x-1.20944538
    ASMALL_M1000c=-1.18612053*x**2+4.91186256*x-1.98337952
    PSMALL_M1000c=1.33135179*x**2-3.7042898*x+1.67853762
    
    nu_f_nu=ACAP_M1000c*sqrt(ASMALL_M1000c*nu/2.d0/PI)* &
         & (1.d0+(1.d0/(nu*ASMALL_M1000c))**PSMALL_M1000c)* &
         & exp(-ASMALL_M1000c*nu/2.d0)

    dNdM1000c=2.d0*nu_f_nu*RHO_M/M1000c*(-1.d0/SIGMA_R(RSIZE)*DSIGMADM)

  END FUNCTION dNdM1000c

  FUNCTION MF_M500C_INTEGRAL(MASS_MIN,MASS_MAX,REDSHIFT)

    IMPLICIT NONE
    REAL(8) :: MASS_MIN, MASS_MAX, REDSHIFT
    REAL(8) :: MF_M500c_INTEGRAL
    INTEGER, PARAMETER :: NMASS_INT=500
    INTEGER :: IMASS_INT
    REAL(8) :: LNM_MIN, LNM_MAX, DELTAM_INT, MASS_TEMP
    REAL(8) :: MF_INT_MIN, MF_INT_MAX, MF_INT_TEMP

    LNM_MAX=log(MASS_MAX)
    LNM_MIN=log(MASS_MIN)
    DELTAM_INT=(LNM_MAX-LNM_MIN)/dble(NMASS_INT-1)

    MF_INT_MIN=dNdM500c(MASS_MIN,REDSHIFT)
    MF_INT_MAX=dNdM500c(MASS_MAX,REDSHIFT)
    MF_INT_TEMP=0.d0

    DO IMASS_INT=2,NMASS_INT-1
       MASS_TEMP=exp(LNM_MIN+(LNM_MAX-LNM_MIN)* &
            &    dble(IMASS_INT-1)/dble(NMASS_INT-1))
       MF_INT_TEMP=MF_INT_TEMP+dNdM500c(MASS_TEMP,REDSHIFT)
    END DO

    MF_M500c_INTEGRAL=DELTAM_INT/2.d0*(MF_INT_MIN+MF_INT_MAX+2.d0*MF_INT_TEMP)

  END FUNCTION MF_M500C_INTEGRAL

  FUNCTION MF_M1000C_INTEGRAL(MASS_MIN,MASS_MAX,REDSHIFT)
    
    IMPLICIT NONE
    REAL(8) :: MASS_MIN, MASS_MAX, REDSHIFT
    REAL(8) :: MF_M1000c_INTEGRAL
    INTEGER, PARAMETER :: NMASS_INT=500
    INTEGER :: IMASS_INT
    REAL(8) :: LNM_MIN, LNM_MAX, DELTAM_INT, MASS_TEMP
    REAL(8) :: MF_INT_MIN, MF_INT_MAX, MF_INT_TEMP
    
    LNM_MAX=log(MASS_MAX)
    LNM_MIN=log(MASS_MIN)
    DELTAM_INT=(LNM_MAX-LNM_MIN)/dble(NMASS_INT-1)
    
    MF_INT_MIN=dNdM1000c(MASS_MIN,REDSHIFT)
    MF_INT_MAX=dNdM1000c(MASS_MAX,REDSHIFT)
    MF_INT_TEMP=0.d0
    
    DO IMASS_INT=2,NMASS_INT-1
       MASS_TEMP=exp(LNM_MIN+(LNM_MAX-LNM_MIN)* &
            &   dble(IMASS_INT-1)/dble(NMASS_INT-1))
       MF_INT_TEMP=MF_INT_TEMP+dNdM1000c(MASS_TEMP,REDSHIFT)
    END DO
    
    MF_M1000c_INTEGRAL=DELTAM_INT/2.d0*(MF_INT_MIN+MF_INT_MAX+2.d0*MF_INT_TEMP)
    
  END FUNCTION MF_M1000C_INTEGRAL

END MODULE MF
